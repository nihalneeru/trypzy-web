# Promising Windows Documentation

## Overview

Promising windows are 2-3 top date windows generated by the consensus algorithm for trip refinement. They help users focus on the most promising date ranges when scheduling collaborative trips.

## Where They Are Computed

**Computed on fetch** (not stored in database):
- Computed in `GET /api/trips/:id` endpoint
- Function: `generatePromisingWindows()`
- Location: `app/api/[[...path]]/route.js`

**Why computed on fetch:**
- Deterministic and stable across refreshes
- Always reflects current availability data
- No database storage needed
- Automatically updates when availability changes

## Exact Shape Returned to Frontend

The `promisingWindows` field in the GET `/api/trips/:id` response:

```typescript
promisingWindows: Array<{
  optionKey: string;        // Format: "YYYY-MM-DD_YYYY-MM-DD"
  startDate: string;        // ISO date string: "YYYY-MM-DD"
  endDate: string;          // ISO date string: "YYYY-MM-DD"
  score: number;            // Normalized score (0-1), higher is better
  totalScore: number;       // Raw score before normalization
  coverage: number;         // Fraction of days with availability data (0-1)
}>
```

**Example Response:**
```json
{
  "promisingWindows": [
    {
      "optionKey": "2024-06-15_2024-06-17",
      "startDate": "2024-06-15",
      "endDate": "2024-06-17",
      "score": 0.85,
      "totalScore": 7.65,
      "coverage": 1.0
    },
    {
      "optionKey": "2024-06-22_2024-06-24",
      "startDate": "2024-06-22",
      "endDate": "2024-06-24",
      "score": 0.72,
      "totalScore": 6.48,
      "coverage": 1.0
    },
    {
      "optionKey": "2024-06-08_2024-06-10",
      "startDate": "2024-06-08",
      "endDate": "2024-06-10",
      "score": 0.65,
      "totalScore": 5.85,
      "coverage": 0.95
    }
  ]
}
```

## Number of Windows

- **Preferred:** 3 windows
- **Minimum:** 2 windows (if available)
- **Fallback:** Returns whatever is available (could be 0, 1, 2, or 3)

## How It Works with Broad/Weekly Availability

The promising windows algorithm automatically handles all availability types:

### Broad Availability
- **"available"** status → All days in trip range treated as "available"
- **"maybe"** status → All days in trip range treated as "maybe"
- **"unavailable"** status → All days in trip range treated as "unavailable"

### Weekly Blocks
- Each weekly block's status applies to all days within that block's date range
- Multiple weekly blocks can cover different date ranges

### Per-Day Availability
- Highest precedence - overrides broad and weekly for specific days
- Used for refined availability on specific dates

### Normalization Process
1. Broad availability sets baseline for all days
2. Weekly blocks override broad for their date ranges
3. Per-day records override everything for specific days
4. Normalized per-day view is used for consensus calculation

## Algorithm Details

- Uses existing `calculateConsensus()` function (no rewrite)
- Scores each possible date window of `tripDuration` days
- Scoring:
  - `available` = +1 point
  - `maybe` = +0.5 points
  - `unavailable` = 0 points
- Normalized by: `totalScore / (tripDuration * totalUsers)`
- Sorted by score (descending), then by startDate (ascending) for determinism
- Returns top 2-3 windows

## Backward Compatibility

- `consensusOptions` field still returned (same data as `promisingWindows`)
- Existing frontend code using `consensusOptions` continues to work
- `promisingWindows` is the new recommended field name

## When Windows Are Generated

- **Generated:** For collaborative trips in `"proposed"` or `"scheduling"` status
- **Not generated:** For `"locked"` trips or `"hosted"` trips
- **Empty array:** Returned if no availability data exists

## Stability & Determinism

- **Deterministic:** Same availability data always produces same windows
- **Stable:** Windows don't change unless availability data changes
- **Sorted consistently:** By score, then by startDate for tie-breaking





